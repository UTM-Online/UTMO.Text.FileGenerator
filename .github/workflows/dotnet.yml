# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
    
env:
  VERSION: 2.15.${{ github.run_number }}

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: src/global.json
        
    - name: Restore dependencies
      run: dotnet restore src/UTMO.Text.FileGenerator.slnx
      
    - name: Build
      run: dotnet build src/UTMO.Text.FileGenerator.slnx --no-restore
      
    - name: Test
      run: dotnet test src/UTMO.Text.FileGenerator.slnx --no-build --verbosity normal
      
    - name: Package
      run: dotnet pack src/UTMO.Text.FileGenerator.slnx -c Release -o '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish' /p:PackageVersion=${{ env.VERSION }}
      
    - name: Configure Nuget Push Target
      run: dotnet nuget add source --name PHX2 "https://packages.public.utmonline.net/nuget/TextFileGeneration/v3/index.json"
      
    - name: Push to Nuget
      run: dotnet nuget push '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish/*.nupkg' --source PHX2 --skip-duplicate --api-key ${{ secrets.PACKAGES_PUSH_SECRET }}
    
    - name: Create GitHub Release
      run: gh release create v${{ env.VERSION }} --title "Release ${{ env.VERSION }}" --notes "Automated release for version ${{ env.VERSION }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push to GitHub Packages
      run: dotnet nuget push '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish/*.nupkg' --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
    
    - name: Publish
      uses: actions/upload-artifact@v6
      with:
        name: published-app
        path: '${{ github.workspace }}/src/UTMO.Text.FileGenerator/publish'
